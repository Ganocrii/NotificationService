syntax = "proto3";

package notifications;

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";

// ENUMS: канал уведомления и статус уведомления

enum NotificationChannel {
  CHANNEL_UNSPECIFIED = 0;
  ALL = 1;
  PUSH = 2;
  SMS = 3;
  EMAIL = 4;
}

enum NotificationStatus {
  STATUS_UNSPECIFIED = 0;
  PENDING = 1;
  SEND = 2;
  READ = 3;
  FAILED = 4;
  RETRYING = 5;
}

// Сам сервис уведомлений

service Notifications {

// API уведомлений
  
  // Создать (отправить) уведомление для пользователя
  rpc CreateNotification (CreateNotificationRequest) returns (CreateNotificationResponse) {
    option (google.api.http) = { 
      post: "/v1/users/{user_id}/notifications" 
      body: "*"
    };
  }
  // Получить статус уведомления
  rpc GetNotificationStatus (GetNotificationStatusRequest) returns (GetNotificationStatusResponse) {
    option (google.api.http) = { get: "/v1/notifications/{notification_id}/status" };
  }
  // Установить стрим получения уведомлений для конкретного пользователя
  rpc SubscribeToUserNotifications (SubscribeToUserNotificationsRequest) returns (stream StreamUserNotificationsResponse); // Тут вопрос возможно ли настроить REST для стрима?
  // Получить все уведомления для пользователя
  rpc GetUserNotifications (GetUserNotificationsRequest) returns (GetUserNotificationsResponse) {
    option (google.api.http) = { get: "/v1/users/{user_id}/notifications" };
  }
  // Пометить уведомление как прочитанное (для push уведомлений в приложении)
  rpc MarkNotificationRead (MarkNotificationReadRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = { post: "/v1/notifications/{notification_id}:read" };
  }
  // Подтвердить доставку уведомления (для email/смс)
  rpc AckNotificationDelivery (AckNotificationDeliveryRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = { post: "/v1/notifications/{notification_id}:ack"};
  }

// API шаблонов уведомлений
  
  // Создать новый шаблон
  rpc CreateTemplate (CreateTemplateRequest) returns (Template) {
    option (google.api.http) = { 
      post: "/v1/templates"
      body: "template"
    };
  }
  // Получить данные шаблона
  rpc GetTemplate (GetTemplateRequest) returns (Template) {
    option (google.api.http) = { get: "/v1/templates/{template_id}" };
  }
  // Обновить шаблон
  rpc UpdateTemplate (UpdateTemplateRequest) returns (Template) {
    option (google.api.http) = { 
      put: "/v1/templates/{template.template_id}" 
      body: "template"
    };
  }
  // Удалить шаблон
  rpc DeleteTemplate (DeleteTemplateRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = { delete: "/v1/templates/{template_id}" };
  }
}

// Сущности API

message Notification {
  int32 notification_id = 1;
  string title = 2;
  string body = 3;
  NotificationStatus status = 4;
  NotificationChannel channel = 6;
  int64 timestamp = 5;
}

message Template {
  int32 template_id = 1;
  string name = 2;     // Название шаблона
  string title = 3;    // Заголовок уведомления
  string body = 4;     // Тело (с переменными {{var}})
  NotificationChannel channel = 5;
}

// Сообщения API

message CreateNotificationRequest {
  int32 user_id = 1;
  NotificationChannel channel = 2;
  int32 template_id = 3;
  map<string, string> variables = 4;
}

message CreateNotificationResponse {
  int32 notification_id = 1;
  NotificationStatus status = 2;
  string message = 3;
}

message GetNotificationStatusRequest {
  int32 notification_id = 1;
}

message GetNotificationStatusResponse {
  int32 notification_id = 1;
  NotificationStatus status = 2;
}

message GetUserNotificationsRequest {
  int32 user_id = 1;
}

message GetUserNotificationsResponse {
  repeated Notification notifications = 1;
}

message SubscribeToUserNotificationsRequest {
  int32 user_id = 1;
}

message StreamUserNotificationsResponse {
  int32 notification_id = 1;
  string title = 2;
  string body = 3;
  int64 timestamp = 4;
}

message MarkNotificationReadRequest {
 int32 notification_id = 1;
}

message AckNotificationDeliveryRequest {
 int32 notification_id = 1;
}

message CreateTemplateRequest {
  Template template = 1;
}

message GetTemplateRequest {
 int32 template_id = 1;
}

message UpdateTemplateRequest {
  Template template = 1;
}

message DeleteTemplateRequest {
 int32 template_id = 1;
}
