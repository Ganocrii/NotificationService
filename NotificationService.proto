syntax = "proto3";

package notifications;

import "google/protobuf/empty.proto";

// ENUMS: канал уведомления и статус уведомления

enum NotificationChannel {
  ALL = 1;
  PUSH = 2;
  SMS = 3;
  EMAIL = 4;
}

enum NotificationStatus {
  PENDING = 1;
  SEND = 2;
  READ = 3;
  FAILED = 4;
  RETRYING = 5;
}

// Сам сервис уведомлений

service Notifications {

// API уведомлений
  
  rpc CreateNotification (CreateNotificationRequest) returns (CreateNotificationResponse);
  rpc GetNotificationStatus (GetNotificationStatusRequest) returns (GetNotificationStatusResponse);
  rpc SubscribeToUserNotifications (SubscribeToUserNotificationsRequest) returns (stream StreamUserNotificationsResponse);
  rpc GetUserNotifications (GetUserNotificationsRequest) returns (GetUserNotificationsResponse);
  rpc MarkNotificationRead (MarkNotificationReadRequest) returns (google.protobuf.Empty);
  rpc AckNotificationDelivery (AckNotificationDeliveryRequest) returns (google.protobuf.Empty);

// API шаблонов уведомлений
  
  rpc CreateTemplate (CreateTemplateRequest) returns (Template);
  rpc GetTemplate (GetTemplateRequest) returns (Template);
  rpc UpdateTemplate (UpdateTemplateRequest) returns (Template);
  rpc DeleteTemplate (DeleteTemplateRequest) returns (google.protobuf.Empty);
}

// Сущности API

message Notification {
  int32 notification_id = 1;
  string title = 2;
  string body = 3;
  NotificationStatus status = 4;
  NotificationChannel channel = 6;
  int64 timestamp = 5;
}

message Template {
  int32 template_id = 1;
  string name = 2;     // Название шаблона
  string title = 3;    // Заголовок уведомления
  string body = 4;     // Тело (с переменными {{var}})
  NotificationChannel channel = 5;
}

// Сообщения API

message CreateNotificationRequest {
  int32 user_id = 1;
  NotificationChannel channel = 2;
  int32 template_id = 3;
  map<string, string> variables = 4;
}

message CreateNotificationResponse {
  int32 notification_id = 1;
  NotificationStatus status = 2;
  string message = 3;
}

message GetNotificationStatusRequest {
  int32 notification_id = 1;
}

message GetNotificationStatusResponse {
  int32 notification_id = 1;
  NotificationStatus status = 2;
}

message GetUserNotificationsRequest {
  int32 user_id = 1;
}

message GetUserNotificationsResponse {
  repeated Notification notifications = 1;
}

message SubscribeToUserNotificationsRequest {
  int32 user_id = 1;
}

message StreamUserNotificationsResponse {
  int32 notification_id = 1;
  string title = 2;
  string body = 3;
  int64 timestamp = 4;
}

message MarkNotificationReadRequest {
 int32 notification_id = 1;
}

message AckNotificationDeliveryRequest {
 int32 notification_id = 1;
}

message CreateTemplateRequest {
  Template template = 1;
}

message GetTemplateRequest {
 int32 template_id = 1;
}

message UpdateTemplateRequest {
  Template template = 1;
}

message DeleteTemplateRequest {
 int32 template_id = 1;
}
